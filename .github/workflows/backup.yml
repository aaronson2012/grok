name: Daily Database Backup

on:
  schedule:
    - cron: '0 4 * * *'
  workflow_dispatch:

jobs:
  backup-discord:
    runs-on: ubuntu-latest
    env:
      FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
      APP_NAME: "grok-bot-discord"
      DB_PATH: "/data/grok.db"
      BACKUP_PATH: "/data/backup.db"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install flyctl
        uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Create Safe Backup on Server
        run: |
            flyctl ssh console -a $APP_NAME -C "python3 -c \"import sqlite3; src=sqlite3.connect('$DB_PATH'); dst=sqlite3.connect('$BACKUP_PATH'); src.backup(dst); dst.close(); src.close(); print('Backup created successfully')\""

      - name: Download Backup via SFTP
        run: |
            flyctl sftp get $BACKUP_PATH -a $APP_NAME

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: discord-db-backup-${{ github.sha }}
          path: backup.db
          retention-days: 30

  backup-telegram:
    runs-on: ubuntu-latest
    env:
      FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
      APP_NAME: "grok-bot-telegram"
      DB_PATH: "/data/grok.db"
      BACKUP_PATH: "/data/backup.db"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install flyctl
        uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Create Safe Backup on Server
        run: |
            flyctl ssh console -a $APP_NAME -C "python3 -c \"import sqlite3; src=sqlite3.connect('$DB_PATH'); dst=sqlite3.connect('$BACKUP_PATH'); src.backup(dst); dst.close(); src.close(); print('Backup created successfully')\""

      - name: Download Backup via SFTP
        run: |
            flyctl sftp get $BACKUP_PATH -a $APP_NAME

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: telegram-db-backup-${{ github.sha }}
          path: backup.db
          retention-days: 30
