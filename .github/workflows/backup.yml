name: Daily Database Backup

on:
  schedule:
    # Run at 4:00 AM UTC daily
    - cron: '0 4 * * *'
  workflow_dispatch:

jobs:
  backup:
    runs-on: ubuntu-latest
    env:
      FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
      APP_NAME: "grok-bot" # MUST match fly.toml
      DB_PATH: "/data/grok.db"
      BACKUP_PATH: "/data/backup.db"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install flyctl
        uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Create Safe Backup on Server
        # Connect to the VM and run python to safely copy the DB
        # We use python's sqlite3 module to avoid dependency on sqlite3 binary version mismatch
        run: |
            flyctl ssh console -a $APP_NAME -C "python3 -c \"import sqlite3; src=sqlite3.connect('$DB_PATH'); dst=sqlite3.connect('$BACKUP_PATH'); src.backup(dst); dst.close(); src.close(); print('Backup created successfully')\""

      - name: Download Backup via SFTP
        run: |
            # We use fly sftp get which handles the tunnel
            flyctl sftp get $BACKUP_PATH -a $APP_NAME

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: grok-db-backup-${{ github.sha }}
          path: backup.db
          retention-days: 30
